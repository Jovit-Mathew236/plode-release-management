name: Update File Versions

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  update-meta:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files (ignore workflow files)
        run: |
          git diff --name-status HEAD~1 HEAD \
            | grep -v '^\.github/workflows/' \
            > changes.txt

      - name: Ensure meta.yaml exists
        run: |
          if [ ! -f meta.yaml ]; then
            echo "files: {}" > meta.yaml
          fi

      - name: Update file versions
        id: update
        run: |
          # Convert YAML to JSON for easy parsing
          apt-get update && apt-get install -y jq yq
          yq -o=json '.files' meta.yaml > files.json

          # Process change list
          while read status name; do
            if [[ "$status" == "D" ]]; then
              jq "del(.\"$name\")" files.json > tmp.json && mv tmp.json files.json
              continue
            fi

            if jq -e ".\"$name\"" files.json > /dev/null; then
              # Increment version
              old_version=$(jq -r ".\"$name\".version" files.json)
              IFS='.' read -r major minor patch <<< "$old_version"
              patch=$((patch+1))
              new_version="$major.$minor.$patch"
            else
              # New file â†’ start version 0.0.1
              new_version="0.0.1"
            fi

            jq ".\"$name\" = {version:\"$new_version\", last_updated:\"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"}" \
              files.json > tmp.json && mv tmp.json files.json

          done < changes.txt

          # Convert back to YAML
          echo "files:" > meta.yaml
          jq -r "to_entries | .[] | \"  \(.key):\n    version: \\\"\(.value.version)\\\"\n    last_updated: \\\"\(.value.last_updated)\\\"\"" files.json >> meta.yaml

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add meta.yaml
          git commit -m "Update per-file versions [skip ci]" || echo "No changes"

      - name: Push changes
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
